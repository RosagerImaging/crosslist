<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.3</storyId>
    <title>Marketplace Credential Management</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-12T20:45:00Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-3-marketplace-credential-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>reseller</asA>
    <iWant>securely connect my marketplace accounts (eBay, Poshmark) via the Chrome Extension</iWant>
    <soThat>the system can automate crosslisting and inventory management operations without manual logins</soThat>
    <tasks>
- [ ] Task 1: Database Schema & Migration (AC: #6, #9)
  - [ ] Subtask 1.1: Create `marketplace_credentials` table with RLS policies (Strict user isolation)
  - [ ] Subtask 1.2: Apply migration to Supabase local and remote

- [ ] Task 2: Backend API Routes (AC: #6, #7, #8, #9)
  - [ ] Subtask 2.1: Implement `POST /api/marketplace/connect` (Stores encrypted creds)
  - [ ] Subtask 2.2: Implement `GET /api/marketplace/status` (Returns connection status only, no creds)
  - [ ] Subtask 2.3: Implement `DELETE /api/marketplace/disconnect` (Removes creds)
  - [ ] Subtask 2.4: Implement `MarketplaceCredentials` service in `lib/services/`

- [ ] Task 3: Extension Content Script Logic (AC: #2, #3, #4, #5)
  - [ ] Subtask 3.1: Create content script for `ebay.com` (Cookie interception)
  - [ ] Subtask 3.2: Create content script for `poshmark.com` (Cookie interception)
  - [ ] Subtask 3.3: Implement `CREDENTIAL_CAPTURED` message with AES-256 encryption (Reuse Encryption Service from 2.2)
  - [ ] Subtask 3.4: Add permission triggers/host permissions to manifest (optional, or use activeTab)

- [ ] Task 4: Frontend "Marketplace Connections" UI (AC: #1, #7, #8, #9, #10)
  - [ ] Subtask 4.1: Create `MarketplaceConnectionCard` component (Status badge, Connect/Disconnect buttons)
  - [ ] Subtask 4.2: Implement "Connect" flow: Open marketplace tab -> Wait for Extension Message -> Call API
  - [ ] Subtask 4.3: Implement "Disconnect" flow: Call API -> Update UI

- [ ] Task 5: Testing (AC: All)
  - [ ] Subtask 5.1: Unit Test: `MarketplaceCredentials` service (Mock Supabase)
  - [ ] Subtask 5.2: Unit Test: Component state transitions (Connected/Disconnected)
  - [ ] Subtask 5.3: E2E Test: Full connection flow (Web -> Ext -> Marketplace -> Web) using Mock Extension
    </tasks>
  </story>

  <acceptanceCriteria>
1. **AC-2.3.1**: Users can initiate marketplace connection from Settings â†’ Marketplace Connections page
2. **AC-2.3.2**: Extension content script activates on eBay.com when "Connect eBay" is clicked
3. **AC-2.3.3**: Extension content script activates on Poshmark.com when "Connect Poshmark" is clicked
4. **AC-2.3.4**: Content script captures session cookies after user manually logs into marketplace
5. **AC-2.3.5**: Captured credentials are encrypted (AES-256) before transmission to web app
6. **AC-2.3.6**: Web app stores encrypted credentials in `marketplace_credentials` table with `user_id` foreign key
7. **AC-2.3.7**: Dashboard displays "Connected" status badge for successfully linked marketplaces
8. **AC-2.3.8**: Dashboard displays "Not Connected" status for unlinked marketplaces
9. **AC-2.3.9**: Users can disconnect marketplace accounts via "Disconnect" button (deletes credentials from database)
10. **AC-2.3.10**: Error states are displayed clearly (e.g., "Failed to capture credentials - please log in again")
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: User Access & Marketplace Connection</title>
        <section>Detailed Design > Data Models and Contracts</section>
        <snippet>Defines `marketplace_credentials` table schema, `POST /api/marketplace/connect` API contract, and Extension Bridge Message Protocol (`CREDENTIAL_CAPTURED`).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>Defines integration points: Web <-> Extension via `useExtensionBridge` and direct DOM manipulation for marketplace adapters.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>apps/chrome-extension/services/encryption.ts</path>
        <kind>service</kind>
        <symbol>EncryptionService</symbol>
        <reason>Reuse existing encryption service for AC-2.3.5 (AES-256 credential encryption).</reason>
      </item>
      <item>
        <path>apps/web/hooks/use-extension-bridge.ts</path>
        <kind>hook</kind>
        <symbol>useExtensionBridge</symbol>
        <reason>Reuse existing bridge hook for AC-2.3.2 (receiving CREDENTIAL_CAPTURED messages).</reason>
      </item>
      <item>
        <path>apps/chrome-extension/manifest.json</path>
        <kind>config</kind>
        <symbol>content_scripts</symbol>
        <reason>Verify host permissions and content script injection definitions for ebay.com and poshmark.com.</reason>
      </item>
    </code>
    <dependencies>
      <ecosystem name="npm">
        <package name="@supabase/ssr" version="^0.8.0" />
        <package name="next" version="^15.0.0" />
        <package name="vite-plugin-web-extension" version="^4.5.0" />
        <package name="@playwright/test" version="^1.57.0" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    - **Security**: Credentials must NEVER be stored or transmitted in plaintext. Encryption must happen in the extension before passing to the web app.
    - **RLS**: Queries to `marketplace_credentials` must be strictly scoped to `auth.uid()`.
    - **Extension**: Must use DOM manipulation/cookie API for capture; avoid brittle selectors where possible, but necessary for cookies.
    - **Compliance**: Respect marketplace terms where possible; use stealth/humanizer patterns for Poshmark if interaction is automated (though this story is mainly capture).
  </constraints>

  <interfaces>
    <interface>
      <name>CREDENTIAL_CAPTURED</name>
      <kind>Message Protocol</kind>
      <signature>{ type: 'CREDENTIAL_CAPTURED', payload: { marketplace: 'ebay'|'poshmark', credentials: EncryptedCredentials } }</signature>
      <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
    </interface>
    <interface>
      <name>POST /api/marketplace/connect</name>
      <kind>REST API</kind>
      <signature>POST /api/marketplace/connect { marketplace, credentials }</signature>
      <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest for unit tests of the EncryptionService and API logic. Use Playwright for E2E testing of the full connection flow, mocking the extension's message passing if necessary, or using specific extension testing capabilities of Playwright.
    </standards>
    <locations>
      <location>apps/web/__tests__</location>
      <location>apps/chrome-extension/__tests__</location>
    </locations>
    <ideas>
      - Test 1: Mock extension sending `CREDENTIAL_CAPTURED` -> verify API call.
      - Test 2: Unit test `EncryptionService` with a sample cookie string.
      - Test 3: RLS test - try to fetch another user's credentials (should fail/return empty).
      - Test 4: E2E - Click "Connect eBay" and verify popup/redirection logic.
    </ideas>
  </tests>
</story-context>
