# Story 7.1: Implement db:types npm script

**Status:** Complete
**Completed:** 2025-12-19

---

## User Story

As a **developer**,
I want **an npm script to automatically generate TypeScript types from the Supabase database schema**,
So that **I don't have to manually run Supabase CLI commands and memorize the correct output path after every database migration**.

---

## Acceptance Criteria

### AC #1: Script Added to package.json

**Given** the root `package.json` is open
**When** I locate the `scripts` section
**Then** I should see a `db:types` script with the command: `supabase gen types typescript --local > apps/web/types/supabase.ts`

### AC #2: Script Executes Successfully

**Given** local Supabase is running (`supabase start`)
**When** I run `npm run db:types` from project root
**Then** the command completes without errors
**And** the file `apps/web/types/supabase.ts` is updated with current database schema types

### AC #3: Generated Types Are Valid

**Given** types have been generated by the script
**When** I run `npm run build` from `apps/web`
**Then** TypeScript compilation succeeds with no type errors
**And** all existing code using `@/types/supabase` continues to work

### AC #4: Documentation Is Clear

**Given** README.md is updated
**When** a developer reads the Database Type Generation section
**Then** they understand when to use `npm run db:types`
**And** they know the prerequisites (Supabase must be running)
**And** they see the alternative command for remote Supabase

### AC #5: Error Handling Works

**Given** local Supabase is NOT running
**When** I run `npm run db:types`
**Then** I receive a clear error message indicating Supabase connection failed

---

## Implementation Details

### Tasks / Subtasks

- [ ] **Step 1: Modify Root package.json** (AC: #1)
  - [ ] Open `/package.json`
  - [ ] Locate the `"scripts"` section
  - [ ] Add `"db:types": "supabase gen types typescript --local > apps/web/types/supabase.ts"` after `generate:api-client`
  - [ ] Save the file

- [ ] **Step 2: Test the Script** (AC: #2, #3)
  - [ ] Ensure Supabase is running: `supabase start`
  - [ ] Run the new script from project root: `npm run db:types`
  - [ ] Verify no error messages in console
  - [ ] Verify file `apps/web/types/supabase.ts` exists and was updated
  - [ ] Verify file contains valid TypeScript types
  - [ ] Verify file size is reasonable (~300-400 lines for current schema)
  - [ ] Run TypeScript compilation: `cd apps/web && npm run build`
  - [ ] Verify build completes without type errors

- [ ] **Step 3: Test Error Handling** (AC: #5)
  - [ ] Stop Supabase: `supabase stop`
  - [ ] Run `npm run db:types`
  - [ ] Verify clear error message about connection failure
  - [ ] Restart Supabase: `supabase start`

- [ ] **Step 4: Update README.md** (AC: #4)
  - [ ] Open `/README.md`
  - [ ] Add "Database Type Generation" section in appropriate location
  - [ ] Document when to use `npm run db:types`
  - [ ] List prerequisites (Supabase must be running)
  - [ ] Include alternative command for remote Supabase
  - [ ] Provide usage examples
  - [ ] Save the file

- [ ] **Step 5: Verify and Commit**
  - [ ] Stage files: `git add package.json README.md`
  - [ ] Commit with descriptive message
  - [ ] Verify commit message follows convention

### Technical Summary

**Approach:**

- Leverage existing Supabase CLI v2.65.6 (already installed as devDependency)
- Use `gen types typescript` command with `--local` flag for local development
- Use shell output redirection (`>`) to write to `apps/web/types/supabase.ts`
- Follow existing `generate:*` script pattern in package.json

**Command Specification:**

```bash
supabase gen types typescript --local > apps/web/types/supabase.ts
```

**Technical Details:**

1. `supabase gen types typescript` - Generates TypeScript type definitions from database schema
2. `--local` - Targets local Supabase instance (localhost:54321)
3. `> apps/web/types/supabase.ts` - Redirects output to existing types file location

**Integration Points:**

- **Supabase CLI**: Uses existing CLI installation
- **TypeScript Build System**: Generated types consumed by TypeScript compiler
- **Database Migration Workflow**: Script run after migrations to sync types
- **Git Workflow**: Generated types committed with migrations

**Developer Workflow:**

1. Apply migration: `supabase db push` or `supabase migration up`
2. Regenerate types: `npm run db:types`
3. Verify build: `npm run build`
4. Commit: `git add supabase/migrations/ apps/web/types/supabase.ts`

### Project Structure Notes

- **Files to modify:**
  - `/package.json` - Add `db:types` script to `scripts` section (line ~20)
  - `/README.md` - Add Database Type Generation section

- **Files affected (output):**
  - `/apps/web/types/supabase.ts` - Regenerated by script (362 lines current)

- **Expected test locations:**
  - No automated tests required (simple shell command wrapper)
  - Manual validation: Script execution, file generation, TypeScript compilation

- **Estimated effort:** 1 story point (20-30 minutes)
  - Implementation: 2 min (package.json)
  - Testing: 8 min (script execution, error handling, build verification)
  - Documentation: 10 min (README.md)

- **Prerequisites:**
  - Supabase CLI v2.65.6 installed (already satisfied)
  - Local Supabase configuration in place (already satisfied)
  - Epic 3 completed (database schema exists)

### Key Code References

**1. Existing Code Generation Pattern:**

- **File**: `/package.json`
- **Location**: Line ~20, `scripts.generate:api-client`
- **Pattern**: External CLI tool → output redirection → committed file
- **Code**:
  ```json
  "generate:api-client": "openapi-typescript-codegen --input http://localhost:8000/openapi.json --output packages/api-client/src --client axios"
  ```
- **New Script Follows This Pattern**: `db:types`

**2. Existing Database Types File:**

- **File**: `/apps/web/types/supabase.ts` (362 lines)
- **Purpose**: TypeScript type definitions for database schema
- **Current Format**: Standard Supabase CLI generated types
- **Usage**: Imported throughout the codebase as `@/types/supabase`

**3. Type Import Locations:**

- **Pattern**: `import { Database } from '@/types/supabase'`
- **Files Using Types**:
  - `/apps/web/lib/hooks/*.ts` - Data fetching hooks
  - `/apps/web/app/api/**/*.ts` - API route handlers
  - `/apps/web/components/**/*.tsx` - Components using database data

**4. Supabase Configuration:**

- **File**: `/supabase/config.toml`
- **Relevant Settings**:
  ```toml
  project_id = "crosslist"
  [api]
  port = 54321
  ```
- **Usage**: Local Supabase instance configuration used by CLI commands

**5. Recent Migrations:**

- **Latest**: `/supabase/migrations/20251214072755_add_deleted_at_to_items.sql`
- **Count**: 5 migrations applied
- **Current Tables**: items, item_images, marketplace_credentials, marketplace_listings, users
- **Workflow**: After migration → run `npm run db:types` (NEW)

---

## Context References

**Tech-Spec:** [tech-spec.md](../tech-spec.md) - Primary context document containing:

- Complete technical specification for database types generation script
- Problem statement and proposed solution
- Implementation steps with time estimates
- Testing strategy and acceptance criteria
- Framework dependencies (Supabase CLI v2.65.6, TypeScript, Next.js)
- Existing patterns to follow (code generation script pattern)
- Integration points (Supabase CLI, TypeScript, migrations, Git)
- Developer resources (file paths, code locations, testing approach)
- Deployment strategy (simple git workflow, no special deployment)

**Architecture:** No specific architecture document needed for this infrastructure improvement

**Epic 3 Retrospective:** `docs/sprint-artifacts/epic-3-retro-2025-12-18.md`

- Lines 101-103: Issue identified - `npm run db:types` script missing
- Lines 217-220: Prioritized as 30-minute task before Epic 4

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debugging required - implementation was straightforward

### Completion Notes

Story 7.1 completed successfully on 2025-12-19.

**Implementation Summary:**
- Added `db:types` npm script to root package.json (line 21)
- Added comprehensive documentation to README.md (lines 147-177)
- Script tested successfully with local Supabase instance
- TypeScript build verified to pass with generated types

**Additional Improvements (Required to Unblock Build):**
1. **Type Handling Fix** - Fixed zod schema and form handling for price field:
   - Reverted to `z.coerce.number()` in inventory schema
   - Removed generic type parameter from useForm to allow proper type inference
   - Added explicit value casting and onChange handler in inventory form

2. **Sentry Configuration Cleanup** - Removed invalid/deprecated options from next.config.ts:
   - Removed `transpileClientSDK` (doesn't exist in @sentry/nextjs v10.30.0)
   - Removed `hideSourceMaps` (replaced by `sourcemaps` option)
   - Removed `disableLogger` (deprecated in favor of `webpack.treeshake.removeDebugLogging`)

3. **ESLint Fix** - Fixed unused variables in inventory-edit.spec.ts test file

**Acceptance Criteria Status:**
- ✅ AC #1: Script added to package.json
- ✅ AC #2: Script executes successfully
- ✅ AC #3: Generated types are valid (build passes)
- ✅ AC #4: Documentation is clear (README.md updated)
- ✅ AC #5: Error handling works (tested with Supabase stopped)

**Time Spent:** ~40 minutes (including build fixes)
**Estimated:** 20-30 minutes
**Variance:** +10-20 minutes (due to pre-existing build issues)

### Files Modified

**Core Implementation:**
- `/package.json` - Added db:types script
- `/README.md` - Added Database Type Generation documentation section

**Build Fixes:**
- `/apps/web/lib/schemas/inventory.ts` - Fixed price field type handling
- `/apps/web/components/inventory/inventory-form.tsx` - Fixed form type inference
- `/apps/web/next.config.ts` - Removed invalid Sentry options
- `/apps/web/playwright/tests/inventory-edit.spec.ts` - Fixed unused variables

**Documentation:**
- `/docs/tech-spec.md` - Created (tech spec for this story)
- `/docs/sprint-artifacts/7-1-implement-db-types-npm-script.md` - This file
- `/docs/epics.md` - Added Epic 7 documentation
- `/docs/bmm-workflow-status.yaml` - Updated workflow status

**Generated Output:**
- `/apps/web/types/supabase.ts` - Regenerated by script (11K)

### Test Results

**Script Execution Test:**
```bash
$ npm run db:types
> crosslist@1.0.0 db:types
> supabase gen types typescript --local > apps/web/types/supabase.ts

✅ SUCCESS - Generated 11K types file
```

**Build Validation:**
```bash
$ npm run build
✅ SUCCESS - Build completed in 72s
   Linting and checking validity of types ...
   Collecting page data ...
   ✓ Generating static pages (15/15)

Route (app)                                 Size  First Load JS
┌ ○ /                                      326 B         217 kB
├ ○ /inventory                           27.6 kB         350 kB
└ ... (13 more routes)
```

**Error Handling Test:**
- Tested with Supabase stopped - received clear connection error
- Error message indicates Supabase must be running

**Type Validation:**
- All existing code using `@/types/supabase` continues to work
- No TypeScript compilation errors
- Generated types include all database tables and enums

---

## Review Notes

<!-- Will be populated during code review -->
